# ファイルベースリアルタイム文字起こし実装プラン

## 概要
現在のメモリベース処理から、ファイルベース処理に変更してリアルタイム文字起こしの安定性を向上させる。

## 実装方針
- **段階的実装**: 既存システムを残しながら新システムを構築
- **シンプル設計**: 並列処理なし、単一ファイル順次処理
- **エラー耐性**: 1回リトライ→失敗時スキップ記録

## 実装ステップ

### Phase 1: 基盤整備
**目標**: チャンクファイル保存とファイル監視機能

#### Step 1.1: 録音制御の拡張
```typescript
// 対象ファイル: src/renderer/components/RecordingControl/*
// 新機能:
- MediaRecorder timeslice設定（20秒間隔）
- チャンクファイル自動保存
- テンポラリフォルダ管理
```

**実装内容:**
- [ ] `RecordingManager.ts` 拡張
  - チャンクサイズ設定追加
  - timeslice有効化
  - ondataavailable イベントハンドラー追加
- [ ] テンポラリフォルダ作成機能
  - `{録音フォルダ}/temp_{録音ファイル名}/` 
- [ ] チャンクファイル命名
  - `chunk_00001_{timestamp}.webm`
  - ゼロパディング5桁のシーケンス番号

#### Step 1.2: ファイル監視システム
```typescript
// 新ファイル: src/renderer/services/ChunkFileWatcher.ts
// 機能:
- テンポラリフォルダの新ファイル検出
- ファイル処理順序保証
- 処理済みファイル管理
```

**実装内容:**
- [ ] `ChunkFileWatcher` クラス作成
  - fs.watch ベースの監視
  - 新ファイル検出イベント
  - 処理待ちキュー管理
- [ ] ファイル完成判定ロジック
  - ファイルサイズ安定確認
  - 書き込み完了待機

### Phase 2: 文字起こし処理
**目標**: 順次ファイル処理とエラーハンドリング

#### Step 2.1: ファイルベース文字起こしエンジン
```typescript
// 新ファイル: src/renderer/services/FileBasedTranscriptionEngine.ts
// 機能:
- 単一ファイル順次処理
- 1回リトライ機能
- スキップ記録
```

**実装内容:**
- [ ] `FileBasedTranscriptionEngine` クラス作成
  - キューベース順次処理
  - リトライロジック（最大1回）
  - エラー分類・記録
- [ ] 処理状態管理
  - 現在処理中ファイル追跡
  - 処理済みファイルリスト
  - エラー統計

#### Step 2.2: 結果統合システム
```typescript
// 新ファイル: src/renderer/services/RealtimeTextManager.ts
// 機能:
- メモリバッファ管理
- ファイル書き込み
- UI表示用データ提供
```

**実装内容:**
- [ ] `RealtimeTextManager` クラス作成
  - インメモリテキストバッファ
  - 追記型ファイル書き込み
  - メタデータ管理（ステータス、進行状況）
- [ ] テキストファイル形式定義
  ```
  [メタデータ]
  status: transcribing
  processed_chunks: 5
  total_chunks: unknown
  
  [本文]
  文字起こし結果...
  
  [処理中マーカー]
  ※ リアルタイム文字起こし中...
  ```

### Phase 3: UI統合
**目標**: 新システムとUIの連携

#### Step 3.1: 表示制御の更新
```typescript
// 対象ファイル: src/renderer/components/SpeechRecognition/*
// 変更:
- ファイル監視ベース表示更新
- メモリベースデータ表示
- 自動スクロール機能
```

**実装内容:**
- [ ] `SpeechRecognition.tsx` 更新
  - テキストファイル監視
  - リアルタイム表示更新
  - 下端自動スクロール
- [ ] 進行状況表示
  - 処理中チャンク表示
  - 完了/エラー統計
  - 推定残り時間

#### Step 3.2: 録音・文字起こし統合ボタン
```typescript
// 対象ファイル: src/renderer/components/RecordingControl/*
// 新機能:
- ワンクリック録音+文字起こし開始
- 統合進行状況表示
- 一括停止機能
```

**実装内容:**
- [ ] `RecordingControl.tsx` 拡張
  - 統合ボタン追加
  - 状態表示更新
  - 同時制御ロジック

### Phase 4: エラーハンドリング・最適化
**目標**: 安定性とパフォーマンス向上

#### Step 4.1: 包括的エラーハンドリング
**実装内容:**
- [ ] ファイルシステムエラー対応
  - 容量不足検出
  - 権限エラー処理
  - 一時的I/Oエラー回復
- [ ] 文字起こしエラー分類
  - サーバー接続エラー
  - 音声品質エラー
  - タイムアウトエラー
- [ ] エラー記録・報告
  - 詳細ログ出力
  - ユーザー通知
  - 統計情報

#### Step 4.2: パフォーマンス最適化
**実装内容:**
- [ ] ファイルI/O最適化
  - バッファリング（3秒間隔書き込み）
  - 非同期書き込み
  - メモリ使用量制御
- [ ] UI更新最適化
  - debounce処理（500ms）
  - 仮想スクロール（長文対応）
  - 差分更新

### Phase 5: 統合・テスト
**目標**: 新旧システムの統合とテスト

#### Step 5.1: システム統合
**実装内容:**
- [ ] 設定による切り替え機能
  ```typescript
  const REALTIME_MODE = 'file'; // 'memory' | 'file'
  ```
- [ ] 互換性保証
  - 既存APIとの互換性
  - データ形式統一
  - 設定引き継ぎ

#### Step 5.2: 総合テスト
**実装内容:**
- [ ] 機能テスト
  - 長時間録音テスト（2時間+）
  - 大量チャンク処理テスト
  - エラー回復テスト
- [ ] パフォーマンステスト
  - メモリ使用量監視
  - ディスク容量消費
  - CPU使用率測定

## ファイル構成

### 新規作成ファイル
```
src/renderer/services/
├── ChunkFileWatcher.ts          # ファイル監視
├── FileBasedTranscriptionEngine.ts  # 文字起こしエンジン
├── RealtimeTextManager.ts       # テキスト管理
└── FileBasedRealtimeProcessor.ts    # 統合制御

src/renderer/types/
└── FileBasedRealtime.ts         # 型定義
```

### 変更対象ファイル
```
src/renderer/components/
├── RecordingControl/
│   ├── RecordingControl.tsx     # 統合ボタン追加
│   └── RecordingManager.ts      # チャンク保存機能
└── SpeechRecognition/
    └── SpeechRecognition.tsx    # ファイルベース表示

src/renderer/services/
└── ChunkTranscriptionManager.ts # ファイルモード統合
```

## データフロー

### 録音 → チャンク保存
```
[録音開始] → [MediaRecorder timeslice] → [ondataavailable]
    ↓
[チャンクファイル保存] → [テンポラリフォルダ] → [ファイル監視検出]
```

### ファイル → 文字起こし
```
[新ファイル検出] → [キューに追加] → [順次処理開始]
    ↓
[文字起こしAPI] → [リトライ処理] → [結果 or スキップ]
    ↓
[メモリバッファ追記] → [ファイル書き込み] → [UI表示更新]
```

### エラーハンドリング
```
[エラー発生] → [種別判定] → [リトライ判定]
    ↓
[成功] → [通常フロー] 
[失敗] → [スキップ記録] → [次ファイル処理]
```

## 設定・定数

### チャンク設定
```typescript
const CHUNK_CONFIG = {
  SIZE_SECONDS: 20,           // チャンクサイズ
  FILE_CHECK_INTERVAL: 1000,  // ファイル監視間隔（ms）
  PROCESSING_TIMEOUT: 180000, // 処理タイムアウト（3分）
  MAX_RETRY_COUNT: 1,         // 最大リトライ回数
};
```

### ファイル設定
```typescript
const FILE_CONFIG = {
  CHUNK_PREFIX: 'chunk_',
  TEMP_FOLDER_PREFIX: 'temp_',
  TEXT_UPDATE_INTERVAL: 3000,  // テキスト書き込み間隔
  SEQUENCE_PADDING: 5,         // シーケンス番号桁数
};
```

### UI設定
```typescript
const UI_CONFIG = {
  DISPLAY_UPDATE_DEBOUNCE: 500, // 表示更新遅延
  AUTO_SCROLL_THRESHOLD: 100,   // 自動スクロール閾値
  STATUS_UPDATE_INTERVAL: 1000, // 進行状況更新間隔
};
```

## リスク・対策

### 高リスク
| リスク | 対策 |
|--------|------|
| ディスク容量不足 | 容量監視・アラート |
| ファイル書き込み失敗 | エラー検出・リトライ |
| 大量ファイル処理 | バッチサイズ制限 |

### 中リスク
| リスク | 対策 |
|--------|------|
| UI更新遅延 | debounce・仮想化 |
| メモリリーク | 定期的ガベージコレクション |
| ファイル残存 | 自動クリーンアップ |

## 成功指標

### 機能指標
- [ ] 2時間連続録音・文字起こし成功
- [ ] エラー率 < 5%
- [ ] 処理遅延 < 30秒

### パフォーマンス指標
- [ ] メモリ使用量 < 500MB
- [ ] CPU使用率 < 30%
- [ ] ディスク書き込み < 1MB/分

## スケジュール

| Phase | 期間 | 主要成果物 |
|-------|------|------------|
| Phase 1 | 3日 | ファイル保存・監視 |
| Phase 2 | 4日 | 文字起こしエンジン |
| Phase 3 | 2日 | UI統合 |
| Phase 4 | 2日 | エラーハンドリング |
| Phase 5 | 2日 | 統合・テスト |
| **合計** | **13日** | **完全実装** |

---

*作成日: 2025-07-18*
*担当: Claude Code*