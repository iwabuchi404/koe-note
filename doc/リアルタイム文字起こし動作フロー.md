# リアルタイム文字起こし動作フロー

## 概要
録音中のWebMファイルに対してチャンク分割による逐次文字起こしを実行するシステム

## 主要コンポーネント

### 1. RealTimeTranscriptionProcessor
- **役割**: リアルタイム文字起こしの中央制御
- **ファイル**: `src/renderer/services/RealTimeTranscriptionProcessor.ts`

### 2. ChunkTranscriptionManager
- **役割**: チャンク処理の統合管理
- **ファイル**: `src/renderer/services/ChunkTranscriptionManager.ts`

### 3. SpeechRecognition コンポーネント
- **役割**: 文字起こし結果の表示
- **ファイル**: `src/renderer/components/SpeechRecognition/SpeechRecognition.tsx`

## 動作フロー詳細

### Phase 1: 初期化・開始
```
1. ユーザーが録音中ファイルに対して文字起こし開始
   ↓
2. ChunkTranscriptionManager.startChunkTranscription() 呼び出し
   ↓
3. 録音中WebMファイル検出
   ↓
4. RealTimeTranscriptionProcessor.startRealTimeTranscription() 開始
   ↓
5. 初期化処理:
   - chunkSequence = 0
   - lastProcessedOffset = 0
   - processedChunks.clear()
   - 処理間隔 5秒のタイマー開始
```

### Phase 2: 定期監視・データ検出
```
タイマー実行（5秒間隔）:
1. checkAndProcessNewData() 実行
   ↓
2. ファイルサイズチェック
   - 現在のファイルサイズ取得
   - 前回処理位置と比較
   ↓
3. 新しいデータ検出判定
   - 推定時間計算: (新しいデータサイズ) / 16000 bytes/秒
   - 最小処理時間（20秒）との比較
   ↓
4. 処理条件満たした場合 → processNewChunk() 呼び出し
```

### Phase 3: チャンク処理
```
processNewChunk() 実行:
1. チャンクID生成: realtime_chunk_{chunkSequence}
   ↓
2. 時間範囲計算:
   - startTime = chunkSequence * chunkSize
   - endTime = startTime + chunkSize
   ↓
3. 重複処理チェック:
   - 既に処理済みか確認
   - 処理中フラグ確認
   ↓
4. 処理中フラグ設定:
   - processingChunkId = chunkId
   - processedChunks.set(processing_{chunkId})
   ↓
5. transcribeRecordingChunk() 呼び出し
```

### Phase 4: WAVファイル作成・文字起こし
```
transcribeRecordingChunk() 実行:
1. リトライループ開始（最大3回）
   ↓
2. createTempWavFromRecording() 呼び出し:
   - WebMファイルからArrayBuffer取得
   - 時間範囲指定でデータ抽出
   - WAVヘッダー追加
   - 一時ファイル保存
   ↓
3. サーバー状態確認:
   - ensureServerRunning()
   ↓
4. 文字起こしAPI呼び出し:
   - window.electronAPI.speechTranscribe()
   ↓
5. 結果処理:
   - ChunkResult形式に変換
   - 成功時: 次チャンクへ進行
   - 失敗時: リトライまたはエラー記録
```

### Phase 5: 結果統合・表示
```
文字起こし完了後:
1. processedChunks.set(chunkId, result)
   ↓
2. コールバック実行:
   - onChunkCompletedCallbacks.forEach()
   ↓
3. イベント発火:
   - chunkTranscriptionCompleted
   ↓
4. SpeechRecognition コンポーネント:
   - transcriptionResult 更新
   - UI再レンダリング
   ↓
5. 次チャンク準備:
   - chunkSequence++
   - lastProcessedOffset 更新
```

## 現在の設定値

### チャンク設定
- **チャンクサイズ**: 20秒
- **処理間隔**: 5秒
- **最小処理時間**: 20秒
- **最大リトライ回数**: 2回

### タイムアウト設定
- **処理中フラグタイムアウト**: 3分
- **エラー回復待機時間**: 15秒
- **サーバー再起動待機**: 3秒

### データ処理
- **推定バイト/秒**: 16,000 bytes
- **最小ファイルサイズ**: 10,000 bytes

## 問題発生パターン

### 1. 処理中フラグスタック
```
症状: "realtime_chunk_X は既に処理中のためスキップ" 繰り返し
原因: finally句でのフラグクリアが不完全
対策: 3分タイムアウトで強制削除
```

### 2. サーバー接続切断
```
症状: "音声認識サーバーとの接続が切断されました"
原因: 長時間処理でサーバー停止
対策: エラー検出時の自動再起動
```

### 3. チャンク時間範囲エラー
```
症状: 累積時間でサーバークラッシュ
原因: endTime = (chunkSequence + 1) * chunkSize
対策: 固定サイズチャンク: endTime = startTime + chunkSize
```

### 4. データ不足エラー
```
症状: 初回チャンクで処理失敗
原因: 20秒データ不足で処理開始
対策: 初回チャンクの最小時間緩和
```

## フロー図

```
[録音開始] → [WebM生成] → [ファイル監視]
     ↓              ↓           ↓
[チャンク0]    [チャンク1]   [チャンク2] ...
 0-20秒       20-40秒      40-60秒
     ↓              ↓           ↓
[WAV作成]    [WAV作成]    [WAV作成]
     ↓              ↓           ↓
[文字起こし]  [文字起こし]  [文字起こし]
     ↓              ↓           ↓
[結果統合] ← [結果統合] ← [結果統合]
     ↓
[UI表示更新]
```

## 状態遷移

```
[待機] → [データ検出] → [処理中] → [完了] → [次チャンク準備] → [待機]
                          ↓
                      [エラー] → [リトライ] → [処理中]
                          ↓
                      [失敗] → [次チャンク準備]
```

## ログ出力パターン

### 正常フロー
```
🎆 リアルタイム文字起こし開始
📊 ファイルサイズチェック
📈 新しいデータを検出
🎯 処理開始条件満たしました
🎯 チャンク時間範囲: X.Xs - Y.Ys
🎵 時間ベース抽出
💾 一時WAVファイル作成完了
🔊 文字起こしAPI呼び出し
✅ チャンク処理完了
🎯 次のチャンクの準備
```

### エラーフロー
```
❌ チャンク処理エラー
⚠️ サーバー関連のエラーを検出
🧹 処理中フラグ削除
🎯 エラー時 - 次のチャンクの準備
```


## 改善案
- 録音制御
1. 録音開始が押される
2. 録音開始
3. 保存用に内容が空のファイル作成
4. テンポラリ用にファイル名と同じフォルダ作成
5. チャンクサイズがたまったらチャンクごとにファイル保存
6. 録音停止が押される
7. トータル録音ファイルを空のファイルに上書き

- 文字起こし制御
1. リアルタイム文字起こし開始
2. テンポラリフォルダに新しいファイルがあるか定期的にチェック
3. 新しいファイルがあったら文字起こし開始
4. １ファイルの文字起こしが終わるテキストをテキストファイルに書きだし、なければ作成
5. 次のファイルを文字起こし開始、次のファイルがなければテンポラリフォルダを定期的にチェック
6. 3に戻る

- UI制御
  - 文字起こし結果エリア
    - 基本は書き出されたテキストの情報を表示、定期的にファイルを監視してアップデートされていたら再読み込み
    - 読み込み終わったら一番下にスクロール
   - 文字起こしエリア
    - チャンク書き出し状況、チャンク文字起こし状況それぞれを監視して表示
   - 録音コントロール
     - 録音ボタンの隣に録音・文字起こしボタンを追加、このボタンが押されたら即座に文字起こし動作を開始 

---

*最終更新: 2025-07-18*