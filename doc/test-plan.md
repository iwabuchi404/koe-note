# KoeNote テストプラン

## 概要
コスト効率を重視した最低限のテスト戦略。メイン機能の品質確保と回帰防止に焦点を当てる。

## テスト環境
- **Vitest**: ユニット・統合テスト
- **Playwright**: E2Eテスト  
- **Testing Library**: Reactコンポーネントテスト

## 優先度別テスト計画

### 🔴 優先度：高（必須）
**ビジネスクリティカルな機能**

#### 1. 録音機能テスト
- **ユニット**: `useRecordingControl`フック
- **統合**: 録音開始→停止→ファイル保存の流れ
- **E2E**: UIから録音実行

#### 2. 文字起こし機能テスト  
- **ユニット**: `ChunkTranscriptionQueue`クラス
- **統合**: 音声ファイル→チャンク分割→文字起こしの流れ
- **E2E**: ファイル選択→文字起こし実行

#### 3. ログシステムテスト
- **ユニット**: `Logger`、`LoggerFactory`
- **統合**: カテゴリ別ログ出力とレベル制御

### 🟡 優先度：中（推奨）

#### 4. 音声再生機能テスト
- **ユニット**: `useAudioPlayer`フック
- **統合**: 音声ファイル読み込み→再生制御→音量・シーク操作
- **機能**: 再生/一時停止、シーク、音量制御、再生速度制御、エラーハンドリング

#### 5. ファイル表示・管理テスト
- **ユニット**: ファイル表示コンポーネント
- **統合**: ファイルリスト取得→フィルタリング→操作（削除、エクスポート）
- **機能**: ファイルペアリング、統計情報、パフォーマンス対応

#### 6. 設定管理テスト
- **ユニット**: `SettingsContext`
- **統合**: 設定保存・読み込み

#### 7. ファイル管理テスト
- **ユニット**: `FileServiceV2`
- **統合**: ファイル読み書き、一時ファイル管理

### 🟢 優先度：低（余裕があれば）

#### 8. UIコンポーネントテスト
- **コンポーネント**: `BottomPanel`、`SettingsModal`
- **アクセシビリティ**: キーボード操作、スクリーンリーダー対応

## テストケース仕様

### 1. 録音機能テスト

#### ユニット: `useRecordingControl.test.ts`
```typescript
describe('useRecordingControl', () => {
  it('録音開始ができること', async () => {
    // 録音開始→状態確認→コールバック実行確認
  })
  
  it('録音停止ができること', async () => {
    // 録音停止→ファイル保存確認→状態リセット確認
  })
  
  it('エラー時に適切にハンドリングされること', async () => {
    // エラー発生→エラーコールバック実行→状態復旧確認
  })
})
```

#### E2E: `recording.spec.ts`
```typescript
test('録音から保存まで', async ({ page }) => {
  await page.goto('/')
  await page.click('[data-testid="record-button"]')
  await page.waitForSelector('[data-testid="recording-indicator"]')
  await page.click('[data-testid="stop-button"]')
  await page.waitForSelector('[data-testid="file-saved-message"]')
})
```

### 2. 文字起こし機能テスト

#### ユニット: `ChunkTranscriptionQueue.test.ts`
```typescript
describe('ChunkTranscriptionQueue', () => {
  it('チャンクをキューに追加できること', () => {
    // チャンク追加→キュー状態確認
  })
  
  it('優先度順で処理されること', async () => {
    // 複数チャンク追加→処理順序確認
  })
  
  it('エラー時にリトライされること', async () => {
    // エラー発生→リトライ実行→最終的な成功/失敗確認
  })
})
```

#### 統合: `transcription-flow.test.ts`
```typescript
describe('文字起こしフロー', () => {
  it('音声ファイルが正常に文字起こしされること', async () => {
    // ファイル読み込み→チャンク分割→文字起こし→結果統合
  })
})
```

### 3. ログシステムテスト

#### ユニット: `Logger.test.ts`
```typescript
describe('Logger', () => {
  it('ログレベル別で出力制御されること', () => {
    // レベル設定→各レベルでログ出力→出力確認
  })
  
  it('構造化データが正しく出力されること', () => {
    // データ付きログ→フォーマット確認
  })
})
```

### 4. 音声再生機能テスト

#### ユニット: `useAudioPlayer.test.ts`
```typescript
describe('useAudioPlayer', () => {
  it('音声ファイルが正常に読み込まれること', async () => {
    // ファイル読み込み→メタデータ取得→再生準備完了
  })
  
  it('再生制御が正常に動作すること', async () => {
    // 再生/一時停止/シーク→状態確認
  })
  
  it('音量・再生速度制御が動作すること', () => {
    // 音量設定→範囲制限確認、再生速度設定→範囲制限確認
  })
  
  it('エラー時に適切にハンドリングされること', async () => {
    // 読み込み/再生エラー→エラー状態確認→復旧確認
  })
})
```

### 5. ファイル表示・管理機能テスト

#### ユニット: `fileDisplay.test.ts`
```typescript
describe('ファイル表示機能', () => {
  it('ファイルリストが正しく取得・表示されること', async () => {
    // ファイルリスト取得→ソート確認→表示確認
  })
  
  it('音声ファイルと文字起こしファイルがペアリングされること', () => {
    // ファイルペアリング→関連付け確認
  })
  
  it('ファイル操作が正常に動作すること', async () => {
    // 削除/エクスポート/場所を開く→結果確認
  })
  
  it('フィルタリング・検索が動作すること', async () => {
    // 種類別フィルタ→名前検索→日付範囲フィルタ
  })
  
  it('大量ファイル処理でパフォーマンスが維持されること', () => {
    // ページネーション→仮想化→レスポンス確認
  })
})
```

## テスト実行戦略

### 開発フロー統合
```json
{
  "scripts": {
    "test": "vitest",
    "test:unit": "vitest run tests/unit",
    "test:e2e": "playwright test",
    "test:ci": "npm run test:unit && npm run test:e2e"
  }
}
```

### CI/CD統合（将来）
- プルリクエスト時: ユニットテスト必須実行
- マージ前: E2Eテスト実行
- リリース前: 全テスト実行

## 期待効果とROI

### 🎯 直接効果
- **品質向上**: クリティカル機能の回帰防止
- **開発効率**: 手動テスト時間の削減
- **信頼性**: リファクタリング時の安全性確保

### 📊 測定指標
- **カバレッジ**: クリティカル機能80%以上
- **実行時間**: ユニットテスト<30秒、E2E<5分
- **障害検出**: 本番障害の70%以上をテストで事前検出
- **テスト網羅率**: コア機能5つ+拡張機能2つ=7つのテスト領域をカバー

### 💰 コスト試算
- **初期構築**: 1-2日（完了）
- **テストケース作成**: 機能あたり2-4時間（完了）
- **メンテナンス**: 新機能開発の10-20%

### 🎉 実装完了状況
- **基盤構築**: 100%完了
- **ユニットテスト**: 5つのテストファイル作成完了
- **E2Eテスト**: 2つの主要フロー作成完了
- **追加テスト**: 音声再生・ファイル表示テスト追加完了

## 今回の実装範囲（最低限）

### Phase 1: 基盤構築（完了）
- ✅ Vitest/Playwright環境構築
- ✅ モック設定
- ✅ テスト用ディレクトリ構造

### Phase 2: コアテスト実装（完了）
- ✅ 録音機能のユニットテスト
- ✅ ログシステムのユニットテスト
- ✅ 基本的なE2Eテスト

### Phase 3: 拡張機能テスト（完了）
- ✅ 文字起こし機能テスト
- ✅ 音声再生機能テスト
- ✅ ファイル表示・管理機能テスト

## 注意点・制約

### 技術的制約
- **Electron環境**: プリロード・メインプロセスの複雑性
- **音声API**: ブラウザ権限・デバイス依存性
- **WebM/音声処理**: バイナリデータのモック化難易度

### コスト制約
- **最小限の実装**: ROIの高い部分のみ
- **段階的拡張**: 必要に応じて追加テスト実装
- **メンテナンス性**: シンプルで理解しやすいテスト

## 実装したテストファイル一覧

### ユニットテスト（tests/unit/）
1. **Logger.test.ts** - ログシステムのテスト
2. **useRecordingControl.test.ts** - 録音制御フックのテスト  
3. **ChunkTranscriptionQueue.test.ts** - 文字起こしキューのテスト
4. **useAudioPlayer.test.ts** - 音声再生フックのテスト（追加）
5. **fileDisplay.test.ts** - ファイル表示・管理機能のテスト（追加）

### E2Eテスト（tests/e2e/）
1. **recording.spec.ts** - 録音機能のE2Eテスト + 音声再生テスト
2. **transcription.spec.ts** - 文字起こし機能のE2Eテスト（実音声ファイル使用）
3. **testdata/recording_test.webm** - テスト用音声ファイル

### 設定ファイル
- **vitest.config.ts** - Vitest設定
- **playwright.config.ts** - Playwright設定
- **tests/setup.ts** - テスト環境のモック設定

### 実行スクリプト（package.json）
- `npm run test` - 全テスト実行
- `npm run test:unit` - ユニットテストのみ
- `npm run test:e2e` - E2Eテストのみ
- `npm run test:ci` - CI環境用

## 🎵 実際の音声ファイルを使用したテスト

### 新機能：実音声ファイルテスト
- **テスト用音声ファイル**: `tests/e2e/testdata/recording_test.webm`
- **実際の文字起こし処理**: Whisperサーバーへのリアルなリクエスト
- **音声再生テスト**: HTMLAudioElementを使用した実際の再生

### テストの進化
- **従来**: モックのみのテスト
- **現在**: 実ファイル + モックの組み合わせ
- **効果**: より現実的なテストによる品質向上

### 実行方法
```bash
# UI付きで実行（推奨）
npm run test:e2e:ui

# ヘッドレスで実行
npm run test:e2e

# 特定テストのみ
npx playwright test transcription.spec.ts
```

この計画により、最小のコストで最大の効果を得られるテスト環境を構築し、音声再生とファイル表示テストに加えて、実際の音声ファイルを使用した現実的なテスト体系を完成させました。